<!DOCTYPE HTML>
<!--
	Dimension by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Dimension by HTML5 UP</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <meta charset="UTF-8" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
		<style>
		  :root{
      --meyer-blue:#003E7E; --muted:#6b7280; --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626;
    }
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:16px;color:#000000}
		    .kpi-grid {display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;}
			.kpi-card {background: rgb(248, 248, 248); padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center;}
			.kpi-title { font-size: 14px; color: #000000; }
			.kpi-value { font-size: 32px; font-weight: bold; margin: 10px 0; color: #024873; }
			.kpi-sub { color: #000000; font-size: 13px; }

			/* Mini-bar chart */
			.chart {display: flex; height: 60px; align-items: flex-end; gap: 4px; margin-top: 5px;}
			.bar {width: 12px; background: #438ec9; border-radius: 3px;}

			/* Section */
			.section {background: rgb(255, 255, 255); padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgb(255, 255, 255); margin-top: 25px;}
			.asset-form input { margin: 5px; padding: 5px; }
			table { width: 100%; border-collapse: collapse; margin-top: 15px; }
			th, td { padding: 8px; border: 1px solid #ccc; text-align: left; }
			th { background: #024873; color: #fff; }
			.actions button { margin-right: 5px; }
			#search { margin-bottom: 10px; padding: 6px; width: 300px; }

    header{background:var(--meyer-blue); color:#fff; padding:12px 16px; font-weight:600}
    .wrap{padding:16px; display:grid; grid-template-columns: 1.2fr 1fr; gap:16px}
    .card{border:1px solid #e5e7eb; border-radius:10px; padding:12px; box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .kpis{display:grid; grid-template-columns: repeat(4, 1fr); gap:12px}
    .kpi{padding:10px 12px; border-radius:10px; background:#f9fafb; border:1px solid #e5e7eb}
    .kpi .label{font-size:12px; color:var(--muted)}
    .kpi .value{font-size:22px; font-weight:700}
    .rag{display:flex; gap:8px}
    .rag span{padding:6px 10px; border-radius:999px; font-size:12px; color:#fff}
    .rag .g{background:var(--ok)} .rag .y{background:var(--warn)} .rag .r{background:var(--bad)}
    .controls{display:flex; gap:12px; flex-wrap:wrap}
    select,button{padding:6px 10px; border-radius:8px; border:1px solid #fff; background:#ffffff41}
    table{width:100%; border-collapse:collapse; font-size:12.5px}
    tr:hover{background:#ffffff}
    .mini{font-size:11px; color:var(--muted)}
    .btn{cursor:pointer}
    tr.sel {background-color: #dbeafe; /* light blue */}
		</style>
	</head>
	<body class="is-preload">


								<h2>Johdon etusivu</h2>
  <div class="wrap">
    <section class="card">
      <div class="kpis" id="kpis">
        <div class="kpi"><div class="label">Kokonaisvalmistuminen</div><div class="value" id="kpi-pct">–</div><div class="mini">% of Planned Qty</div></div>
        <div class="kpi"><div class="label">Tehtäviä aikataulussa</div><div class="value" id="kpi-ontrack">–</div><div class="mini">kpl (Status ≠ Delayed)</div></div>
        <div class="kpi"><div class="label">Kustannusdelta</div><div class="value" id="kpi-delta">–</div><div class="mini">€ (sum)</div></div>
        <div class="kpi"><div class="label">Päivitys</div><div class="value" id="kpi-upd">–</div><div class="mini">Viimeisin data</div></div>
      </div>
      <div class="controls" style="margin:12px 0">
        <label>Alue:
          <select id="filter-area"><option value="">Kaikki</option></select>
        </label>
        <label>Suunnitteluala:
          <select id="filter-disc"><option value="">Kaikki</option></select>
        </label>
        <label>Status:
          <select id="filter-status"><option value="">Kaikki</option><option>Planned</option><option>In Progress</option><option>Delayed</option><option>Completed</option></select>
        </label>
        <button class="btn" id="btn-clear">Tyhjennä suodatus</button>
      </div>
      <canvas id="curve" height="110"></canvas>
      <div class="mini">Vinkki: Klikkaa S‑käyrän datapistettä → suodatus malliin (ActivityID‑taso).</div>
      <div style="margin-top:10px;" class="rag" id="rag"></div>
    </section>
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:4px 0">Kriittiset aktiviteetit</h3>
        <button class="btn" id="btn-apply">Näytä valitut mallissa</button>
      </div>
      <table id="tbl">
        <thead>
          <tr>
            <th>ActivityID</th><th>TagID</th><th>Area</th><th>Discipline</th><th>Start</th><th>Finish</th><th>%</th><th>Status</th><th>Δ€</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="mini">Vihje: Valitse 1–n riviä (Ctrl/Shift) → “Näytä valitut mallissa”.</div>
    </section>
  </div>

<script>
const state = { rows:[], filtered:[], selected:new Set() };
const fmt = new Intl.NumberFormat('fi-FI');
const money = n => (n>=0?'+':'') + fmt.format(n);

const exampleData = [
  { ActivityID:'A101', TagID:'T01', Area:'Kansi', Discipline:'Rakenteet', PlannedStart:'2025-11-01', PlannedFinish:'2025-11-07', PlannedQty:100, ActualQty:80, PercentComplete:80, Status:'In Progress', CostDelta:5000 },
  { ActivityID:'A102', TagID:'T02', Area:'Moottori', Discipline:'Mekaniikka', PlannedStart:'2025-11-03', PlannedFinish:'2025-11-10', PlannedQty:50, ActualQty:50, PercentComplete:100, Status:'Completed', CostDelta:0 },
  { ActivityID:'A103', TagID:'T03', Area:'Kansi', Discipline:'Sähkö', PlannedStart:'2025-11-05', PlannedFinish:'2025-11-15', PlannedQty:70, ActualQty:30, PercentComplete:43, Status:'Delayed', CostDelta:-1200 },
  { ActivityID:'A104', TagID:'T04', Area:'Hytti', Discipline:'Sisustus', PlannedStart:'2025-11-02', PlannedFinish:'2025-11-12', PlannedQty:60, ActualQty:40, PercentComplete:67, Status:'In Progress', CostDelta:800 }
];

function computeKPIs(rows){
  const sumPlanned = rows.reduce((a,r)=>a+Number(r.PlannedQty||0),0);
  const sumActual  = rows.reduce((a,r)=>a+Number(r.ActualQty||0),0);
  const pct = sumPlanned? Math.round(100*sumActual/sumPlanned) : 0;
  const ontrack = rows.filter(r=>r.Status!=='Delayed').length;
  const delta = rows.reduce((a,r)=>a+Number(r.CostDelta||0),0);
  document.getElementById('kpi-pct').textContent = pct+"%";
  document.getElementById('kpi-ontrack').textContent = ontrack;
  document.getElementById('kpi-delta').textContent = money(delta);
  const lastUpd = new Date().toISOString().slice(0,10);
  document.getElementById('kpi-upd').textContent = lastUpd;
}

function buildCurve(rows){
  const byWeek = {};
  const parseDate = s=> new Date(s+'T00:00:00');
  rows.forEach(r=>{
    const s = parseDate(r.PlannedStart);
    const f = parseDate(r.PlannedFinish);
    const weeks = Math.max(1, Math.round((f-s)/(1000*60*60*24*7)));
    for(let i=0;i<=weeks;i++){
      const d = new Date(s.getTime()+i*7*24*3600*1000);
      const key = d.getFullYear()+"-W"+('0'+getWeek(d)).slice(-2);
      byWeek[key] = byWeek[key]||{planned:0, actual:0, date:d};
      byWeek[key].planned += Number(r.PlannedQty)/weeks;
      byWeek[key].actual  += Number(r.ActualQty)/weeks;
    }
  });
  const keys = Object.keys(byWeek).sort((a,b)=> byWeek[a].date - byWeek[b].date);
  const labels = keys.map(k=> byWeek[k].date.toISOString().slice(0,10));
  const planned=[]; const actual=[]; let cp=0, ca=0;
  keys.forEach(k=>{ cp+=byWeek[k].planned; ca+=byWeek[k].actual; planned.push(Math.round(cp)); actual.push(Math.round(ca)); })

  const ctx = document.getElementById('curve');
  if(window.curveChart) window.curveChart.destroy();
  window.curveChart = new Chart(ctx,{
    type:'line', data:{ labels,
      datasets:[
        {label:'Planned', data:planned, borderColor:'#9ca3af', tension:.2},
        {label:'Actual', data:actual, borderColor:'#003E7E', tension:.2}
      ]
    }, options:{ responsive:true, interaction:{mode:'nearest', intersect:false},
      plugins:{ legend:{display:true}},
      onClick:(e,elements)=>{
        if(!elements.length) return;
        const idx = elements[0].index;
        const date = new Date(labels[idx]);
        const act = state.filtered.filter(r=> new Date(r.PlannedStart) <= date && date <= new Date(r.PlannedFinish));
        const ids = [...new Set(act.map(r=> r.ActivityID))];
        applyFilter({ activityIds: ids });
      }
    }
  });
}

function buildRAG(rows){
  const g = rows.filter(r=> r.Status==='Completed' || (r.Status==='In Progress' && Number(r.PercentComplete)>=50)).length;
  const y = rows.filter(r=> r.Status==='In Progress' && Number(r.PercentComplete)<50).length;
  const r = rows.filter(r=> r.Status==='Delayed').length;
  const div = document.getElementById('rag');
  div.innerHTML = `<span class="g">Green ${g}</span><span class="y">Amber ${y}</span><span class="r">Red ${r}</span>`;
}

function buildTable(rows){
  const tbody = document.querySelector('#tbl tbody');
  tbody.innerHTML = '';
  rows.slice(0,50).forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.ActivityID}</td><td>${r.TagID}</td><td>${r.Area}</td><td>${r.Discipline}</td><td>${r.PlannedStart}</td><td>${r.PlannedFinish}</td><td>${r.PercentComplete}</td><td>${r.Status}</td><td>${money(Number(r.CostDelta))}</td>`;
    let lastSelectedIndex = null;

    tr.addEventListener('click', (e)=>{
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const index = rows.indexOf(tr);

      if(e.shiftKey && lastSelectedIndex !== null){
        const [start, end] = [lastSelectedIndex, index].sort((a,b)=>a-b);
        for(let i=start; i<=end; i++){
          rows[i].classList.add('sel');
          state.selected.add(state.filtered[i].ActivityID);
        }
      } else if(e.ctrlKey || e.metaKey){
        tr.classList.toggle('sel');
        if(tr.classList.contains('sel')) state.selected.add(r.ActivityID);
        else state.selected.delete(r.ActivityID);
        lastSelectedIndex = index;
      } else {
        // Clear previous selection
        rows.forEach((r,i)=>{
          r.classList.remove('sel');
          state.selected.delete(state.filtered[i].ActivityID);
        });
        tr.classList.add('sel');
        state.selected.add(r.ActivityID);
        lastSelectedIndex = index;
      }
    });
    tbody.appendChild(tr);
  });
}

function populateFilters(rows){
  const set = (id, vals)=>{
    const el = document.getElementById(id);
    [...new Set(vals)].sort().forEach(v=>{ const o=document.createElement('option'); o.value=o.textContent=v; el.appendChild(o); });
    el.addEventListener('change', applyFilters);
  }
  set('filter-area', rows.map(r=>r.Area));
  set('filter-disc', rows.map(r=>r.Discipline));
  document.getElementById('filter-status').addEventListener('change', applyFilters);
  document.getElementById('btn-clear').addEventListener('click', ()=>{
    ['filter-area','filter-disc','filter-status'].forEach(id=> document.getElementById(id).value='');
    applyFilters();
  });
}

function applyFilters(){
  const area = document.getElementById('filter-area').value;
  const disc = document.getElementById('filter-disc').value;
  const stat = document.getElementById('filter-status').value;
  state.filtered = state.rows.filter(r=> (!area||r.Area===area)&&(!disc||r.Discipline===disc)&&(!stat||r.Status===stat));
  computeKPIs(state.filtered); buildCurve(state.filtered); buildRAG(state.filtered); buildTable(state.filtered);
}

function applyFilter(payload){
  window.parent && window.parent.postMessage({ type:'eshare.filter', payload }, '*');
  if(window.eshareApplyFilter){ window.eshareApplyFilter(payload); }
}

document.getElementById('btn-apply').addEventListener('click', ()=>{
  if(!state.selected.size){ 
    alert('Valitse ensin rivejä taulukosta.'); 
    return; 
  }
  const payload = { activityIds: Array.from(state.selected) };
  console.log('Applying filter:', payload);
  alert('Valitut ActivityID:t: ' + payload.activityIds.join(', '));
  applyFilter(payload);
});

function getWeek(d){
  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = date.getUTCDay() || 7;
  date.setUTCDate(date.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
  return Math.ceil((((date - yearStart) / 86400000) + 1)/7)
}

// Initialize demo data
state.rows = exampleData;
populateFilters(state.rows);
state.filtered = state.rows;
computeKPIs(state.rows); buildCurve(state.rows); buildRAG(state.rows); buildTable(state.rows);
</script>

	</body>
</html>
